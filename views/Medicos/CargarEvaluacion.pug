extends ../layout

block head
  link(rel="stylesheet", href="/css/VistaMedico.css")
  link(rel="stylesheet", href="/css/RegistrarAdmision.css") 
  link(rel="stylesheet", href="/css/CargarEvaluacion.css")
  link(rel="stylesheet", href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css")

block scripts
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  script(src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js")
  script(src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js")
  
  script(src="/js/DataTableGlobal.js")
  script(src="/js/Evaluacion.js")

block content
  .contenido-medico
    
    div(style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;")
      h1(style="margin: 0;") Historia Clínica
      a(href="/evaluaciones/pacientes", style="background-color: #6c757d; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;")
        | Volver

    .form-card(style="background-color: #e3f2fd; border-left: 6px solid #2196f3; margin-bottom: 20px; width: 100%; max-width: 100%; box-sizing: border-box;")
      h2(style="margin-top: 0; color: #0d47a1;") 
        | #{admision.paciente.apellido}, #{admision.paciente.nombre}
      
      div(style="display: flex; justify-content: space-between; color: #333; margin-top: 10px;")
        p: strong DNI: #{admision.paciente.documento}
        p: strong Ingreso: #{new Date(admision.fecha_entrada).toLocaleDateString('es-AR')}
        p: strong Diagnóstico: #{admision.motivo ? admision.motivo.descripcion : '-'}

    div(style="text-align: right; margin-bottom: 10px;")
      button#btn-abrir-modal.btn-crearMedico(type="button")
        span.editar-boton
          img.icono-info(src="/img/icon-evaluacion.png", alt="crear")
          | Nueva Evolución

    .form-card(style="background-color: #ffffff; width: 100%; max-width: 100%; box-sizing: border-box; padding: 20px;")
      h3(style="margin-top: 0; margin-bottom: 15px;") Evoluciones Previas
      
      table#TablaMedico.datatable-estandar(style="width: 100%;")
        thead
          tr
            th Fecha
            th Médico
            th Contenido
            th Acciones
        tbody
          if historial
            each ev in historial
              tr
                td(data-sort=ev.fecha)= new Date(ev.fecha).toLocaleString('es-AR')
                td= ev.medico ? ev.medico.apellido : '-'
                
                td(style="font-size: 1em;")
                  if ev.observaciones && ev.observaciones.trim() !== ""
                    span.badge-nota Nota
                  if ev.Tratamientos && ev.Tratamientos.length > 0
                    span.badge-tratamiento Tratamientos
                  if ev.SolicitudPruebas && ev.SolicitudPruebas.length > 0
                    span.badge-estudio Estudios
                  if (!ev.observaciones || ev.observaciones.trim() === "") && (!ev.Tratamientos || ev.Tratamientos.length === 0) && (!ev.SolicitudPruebas || ev.SolicitudPruebas.length === 0)
                    span(style="color:#999; font-style:italic") -

                td
                  a.btn-ver-detalle(
                    href=`/evaluaciones/detalle/${ev.id_evaluacion_medica}`,
                    style="text-decoration: none; display: inline-block;"
                  ) 
                    span.informacion-boton
                      img.icono-info(src="/img/icon-info.png", alt="ver")
                      |  Ver Detalle

  #modal-editar.hidden
    .modal-contenido(style="width: 600px; max-width: 90%;")
      h2 Nueva Evolución
      
      form(action="/evaluaciones/guardar" method="POST")
        input(type="hidden", name="id_admision", value=admision.id_admision)

        div
          label(for="observaciones") Evolución Clínica:
          textarea(name="observaciones", id="observaciones", rows="4", required, placeholder="Escriba la evolución...", style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-bottom: 15px;")

        div(style="margin-bottom: 20px;")
          label(for="select-tratamientos") Indicaciones / Tratamientos:
          select(name="tratamientos", id="select-tratamientos", multiple="multiple", style="width: 100%;")
            if tratamientos
              each t in tratamientos
                option(value=t.id_tratamiento)= t.nombre
            else
              option(disabled) No hay tratamientos cargados

        div(style="margin-bottom: 20px;")
          label(for="select-pruebas") Solicitud de Estudios / Prácticas:
          select(name="pruebas", id="select-pruebas", multiple="multiple", style="width: 100%;")
            if pruebas
              each p in pruebas
                option(value=p.id_tipo_prueba)= p.nombre
            else
              option(disabled) No hay pruebas cargadas

        div(style="margin-top: 15px;")
          button(type="submit") Guardar
          button(type="button", id="cerrar-modal", style="background-color: #dc3545; margin-top: 10px;") Cancelar